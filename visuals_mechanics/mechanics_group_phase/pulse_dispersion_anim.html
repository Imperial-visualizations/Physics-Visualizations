<!doctype html>
<html>
<head>
    <title>Pulse Animation</title>
    <link rel="stylesheet" href="https://manglekuo.com/i-v/styles.css?v=2">
    <link rel="icon" href="./images/favicon.ico" type="image/x-icon">
    <style>
        #graph {
            border: 3px solid #003e74;
        }
    </style>
</head>
<body>

<h1>Travelling pulse at interface (dispersive)</h1>

<div class="container">
    <div class="row">

        <div class="nine columns">
            <div id='graph'></div>  <!-- Plotly chart will be drawn inside this DIV -->
        </div>

        <div class="three columns">

            <!--<h1>Pulse </h1>-->
            <label class="sliderTitle">Number of sine waves:<span id="waves_display"> 2 </span></label>
            <label class="slider">
                <input id="slider_waves" class="inputs" type="range" value="2" min="1" max="100" step="1"/>
                <span class="sliderMin">1</span><span class="sliderMax">100</span>
            </label>

            <label class="sliderTitle">Phase Velocity (non-dispersive):
                <span id="phaseVelocityDisplay" data-unit="m/s"> 1 m/s</span>
            </label>

            <label class="slider">
                <input id="velocityPhase" class="inputs" type="range" value="1" min="0.0" max="1" step="0.05"/>
                <span class="sliderMin">0</span><span class="sliderMax">1</span>
            </label>

            <input id="run_button" type="button" value="play" onclick="onStart()" style="width:200px"/>
            <input id="reset_button" type="button" value="reset" onclick="onReset()" style="width:200px"/>

            <!--Dispersion Relation-->
            <label>Define Dispersion Relation: <br /> &omega;(k) =
                <span id ="dispersionRelation"> </span>
            </label>
            <input id = "function" name="function"><br>
            <p id= "error_omega" style="color:#ff0000"></p>

            <!--k0-->
            <label>Define wave number: <br /> k0 =
                <span id ="k0"> </span>
            </label>
            <input id = "k0_input" >
             <p id= "error_k0" style="color:#ff0000"></p>

            <!--kend-->
             kend =
                <span id ="kend"> </span>
            </label>
            <input id = "kend_input" >
             <p id= "error_kend" style="color:#ff0000"></p>

            <!--Checkbox-->
            <input type="checkbox">


        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://www.numericjs.com/lib/numeric-1.2.6.min.js"></script>
<script src="./calculator.js"></script>

<script>
    // Defining variables (need to update later anyway so importing from e.g. json is meaningless)
    // Wave characteristics:
    var nb_waves = parseInt($("#slider_waves").val());
    var v = parseFloat($("#velocityPhase").val());
    var k0 = 1; //define k0
    var kend = 1.2; //define
    var k_array = [];
    var omega_nondisp = [];
    var omega_disp = [];

    // x and t coordinates
    var n = 801;
    var y_i = [], y_r = [], y_t = [];
    var x = numeric.linspace(-50, 50, n);
    var t = 0.0;
    var dt = 0.02;
    var is_paused = true;
    var y_range = 1;
    var omega_input = false;
    var funct;

    var layout =
        {
            autosize: false,
            width: 700,
            height: 400,
            margin: {
                l: 60,
                r: 35,
                b: 50,
                t: 40,
                pad: 4
            },
            //plot_bgcolor: '#EBEEEE',
            xaxis: {
                range: [-50, 50],
            },
            yaxis: {
                autorange: false,
                range: [-4, 4],
            },
            legend: {
                orientation: 'h',
                x: -0.05,
                y: 1.2,
                fontsize: 25
            },
            font: {
                family: 'Lato',
                size: 16,
                color: '#003E74',
                weight: 900
            }
        };

    // k0
    $("#k0_input").on('keyup',function () {
        if(event.keyCode == 13) {
            // Check it is a number
            if (isNaN(parseFloat($('#k0_input').val()))) {
                $('#error_k0').text('Invalid input: k0 needs to be a number');
            }
            else {
                k0 = parseFloat($('#k0_input').val());
                onReset();
                $('#k0').text(k0);
                $('#k0_input').val('');
                $('#error_k0').text('');
            }
        }
    });

    // kend
    $("#kend_input").on('keyup',function () {
        if(event.keyCode == 13) {
            // Check it is a number
            if (isNaN(parseFloat($('#kend_input').val()))) {
                $('#error_kend').text('Invalid input: kend needs to be a number');
            }
            else {
                kend = parseFloat($('#kend_input').val());
                onReset();
                $('#kend').text(kend);
                $('#kend_input').val('');
                $('#error_kend').text('');
            }

        }
    });

    // Dispersion relation
    $("#function").on('keyup', function () {
        if(event.keyCode == 13) {
            try {
                //            // All the characters allowed are in the square brackets (apart from ^)
                if (/[^0-9ksqrt().*/+-^]/.test($('#function').val())) {
                    throw new Error;
                }
                funct = $('#function').val();
                if ($('#function').val().includes('sqrt')) {
                    funct = $('#function').val().replace('sqrt', 'Math.sqrt');
                }
                if ($('#function').val().includes('^')) {
                    for (var i = 0; i < nb_waves; i++) {
                        if ($('#function').val().includes('k')) {
                            funct = funct.replace(/k/g, k_array[i]);
                            omega_disp[i] = calculator.parse(funct);
                        }
                    }
                }
                else {
                    for (var i = 0; i < nb_waves; i++) {
                        k = k_array[i];
                        omega_disp[i] = eval(funct);
                    }
                }
                $('#dispersionRelation').text($('#function').val());
                $('#function').val("");
                $('#error_omega').text("");
                omega_input = true;
                onReset();
            }
            catch (err) {
                $('#error_omega').text('Invalid equation');
            }
        }

    })


    // Slider waves
    $('#slider_waves').on('input', function () {
        nb_waves = parseFloat($("#slider_waves").val());
        $("#waves_display").text(" " + nb_waves);
        onReset();
        update_y_range();
        if (is_paused === true) {
            Plotly.relayout('graph', {
                "yaxis.range": [-y_range, y_range],
            }
            )
        }
    });

    // Slider phase velocity
    $('#velocityPhase').on('input', function () {
        v = parseFloat($("#velocityPhase").val());
        $("#phaseVelocityDisplay").text(" " + v + " m/s");
        onReset();
    });

    function initial_data(){
        k_array = numeric.linspace(k0, kend, nb_waves);
        omega_nondisp = numeric.linspace(k0*v, kend*v, nb_waves);
        if (omega_input == false) {
             // Default: non-dispersive
            omega_disp = omega_nondisp.slice();
        }
        else {
            if ($('#function').val().includes('^')) {
                    for (var i = 0; i < nb_waves; i++) {
                        if ($('#function').val().includes('k')) {
                            funct = funct.replace(/k/g, k_array[i]);
                            omega_disp[i] = calculator.parse(funct);
                        }
                    }
                }
                else {
                    for (var i = 0; i < nb_waves; i++) {
                        k = k_array[i];
                        omega_disp[i] = eval(funct);
                    }
                }
        }
        for (var i = 0; i <= n; i++) {
            if (x[i] < 0) {
                y_i[i] = 0;
                y_r[i] = 0;
                for (var j = 0; j < nb_waves; j++) {
                    y_i[i] += Math.sin(k_array[j] * x[i] - omega_nondisp[j] * t);
                    y_r[i] += Math.sin(k_array[j] * x[i] - omega_nondisp[j] * t);
                }
            }
            else if (x[i] >= 0){
                y_t[i] = 0;
                for (var j_ = 0; j_ < nb_waves; j_++) {
                    var omega_test = 2 * k_array[j_];
                    B = (2 * (omega_test / k_array[j_]) / (v + (omega_test / k_array[j_])));
                    y_t[i] += B * Math.sin((v / (omega_test / k_array[j_])) * k_array[j_] * x[i] - v * omega_test * t);
                }
            }
        }
    }

    function update_y_range() {
        if (nb_waves < 4) {
            y_range = 4
        }
        else {
            y_range = (nb_waves - (nb_waves % 5)) + 5
        }
    }

    function onReset() {
        is_paused = true;
        t = 0;
        initial_data();

        Plotly.animate('graph',
                {data: [{y: y_i}, {y: y_r}, {y: y_t}]},
                {transition: {duration: 0}, frame: {duration: 0, redraw: false}}
        );
        document.getElementById('run_button').value = (is_paused) ? "Play" : "Pause";
    }

    // Data
    initial_data();

    // Initial plot
    var incident = {
        x: x,
        y: y_i,
        name: "incident",
        line: {width: 2, color: '#960078', simplify: false}
    };

    var reflected = {
        x: x,
        y: y_r,
        name: "reflected",
        line: {width: 2, color: '#E40043', simplify: false}
    };

    var transmitted = {
        x: x,
        y: y_t,
        name: "transmitted",
        line: {width: 2, color: '#00ACD7', simplify: false}
    };

    var boundary = {
        x: [0, 0],
        y: [-105, 105],  // more efficient than updating it when axis change
        mode: "lines",
        name: "boundary",
        line: {width: 3, color: 'black', simplify: false}
    };

    var xline = {
        x: [-15, 15],
        y: [0, 0],
        mode: "lines",
        showlegend: false,
        line: {width: 2, color: '#003E74', simplify: false}
    };


    // Plot graph with interactivity
    Plotly.plot('graph', [incident, reflected, transmitted, boundary, xline], layout);

    // Data update function for animation
    var t_start = t;

    function compute() {
        t += dt;
        // need to find a way to define time limit
        if (t < t_start + 50) {
            for (var i = 0; i < n; i++) {
                if (x[i] < 0) {
                    y_i[i] = 0;
                    y_r[i] = 0;
                    for (var j = 0; j < nb_waves; j++) {
                        y_i[i] += Math.sin(k_array[j] * x[i] - omega_nondisp[j] * t);
                        y_r[i] += Math.sin(k_array[j] * x[i] - omega_nondisp[j] * t);
                    }
                }
                else if (x[i] >= 0) {
                    y_t[i] = 0;
                    for (var j_ = 0; j_ < nb_waves; j_++) {
                        var omega_test = 2 * k_array[j_];
                        B = (2 * (omega_test / k_array[j_]) / (v + (omega_test / k_array[j_])));
                        y_t[i] += B * Math.sin((v / (omega_test / k_array[j_])) * k_array[j_] * x[i] - v * omega_test * t);
                    }
                }
            }
        }
    }

    // Looping function that updates plot
    function update() {

        if (is_paused === false) {

            compute();

            Plotly.animate('graph',
                    {data: [{y: y_i}, {y: y_r}, {y: y_t}]},
                    {transition: {duration: 0}, frame: {duration: 0, redraw: false}}
                    // vastly speeds up animation but won't update any non-animated properties
            );
            requestAnimationFrame(update);
        }
    }

    function onStart() {
        is_paused = !is_paused;
        document.getElementById('run_button').value = (is_paused) ? "Play" : "Pause";
        requestAnimationFrame(update);
    }

    // ToDo: update boundary
    // ToDo: tooltips for input boxes
    // ToDo: Change Initial Wave
    // ToDo: Python?
    // ToDo: Numeric (Clean Up)
    // ToDo: Speed Up
    // ToDo: Wave at Interface (if possible) -> (v1, v2, endpoint and moving window, border height change with plot)
    // Maybe at beginning: need to specify v (ratio of w and k) and how w (/k cause they are
    // proportional) changes with the added sine wave

    // http://www.phikwadraat.nl/
    // http://physics.usask.ca/~hirose/ep225/animation/dispersion/anim-dispersion.html
    // https://en.wikipedia.org/wiki/Dispersion_relation

</script>

</body>
</html>
